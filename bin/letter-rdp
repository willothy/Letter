#!/usr/bin/env node

'use strict';

const { Parser } = require('../src/Parser');

const { readFileSync } = require('fs');
const { dirname, resolve } = require('path');

Error.stackTraceLimit = 0; // Don't print js stack trace when --stack isn't enabled

function main(argv) {
    const [_node, _path, mode, source, ...rest] = argv;

    let printStackTrace = false;
    let minify = false;
    if (rest.includes('-s') || rest.includes('--stack')) {
        printStackTrace = true;
        Error.stackTraceLimit = 100;
        // TODO: Implement parser stack trace
    }

    if (rest.includes('-m') || rest.includes('--minify')) {
        minify = true;
    }

    const parser = new Parser(minify);

    let ast = null;
    if (mode == '-e') {
        ast = parser.parse(source, null);
    } else if (mode == '-f') {
        const program = readFileSync(source, 'utf-8');
        ast = parser.parse(program, String(dirname(resolve(source))));
    }

    if (rest.includes('-t') || rest.includes('--tokens')) {
        console.log(JSON.stringify(parser.tokenList, null, 2));
    }

    if (rest.includes('-a') || rest.includes('--ast')) {
        console.log(JSON.stringify(ast, null, 2));
    }
}

main(process.argv);
